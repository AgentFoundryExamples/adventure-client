# TYPESCRIPT/FRONTEND DEPLOYMENT CONTEXT (STRICT)
# Date: January 2026
# Target Stack: React 19, Vite 7, Node 24 (LTS), Cloud Run

> **ðŸ“– For step-by-step deployment instructions, see [docs/cloud-run-deploy.md](docs/cloud-run-deploy.md)**
>
> This reference document provides the technical philosophy and standards.
> The deployment guide provides practical, copy/paste-ready commands and troubleshooting.

## 1. CORE PHILOSOPHY: "Frontend as a Service"
- **Architecture:** The frontend is NOT a static bucket. It is a **stateless Docker container** deployed to Cloud Run.
- **Serving Strategy:** The container uses a lightweight web server (Nginx) to serve the static assets generated by Vite.
- **Benefits:** Atomic rollbacks, consistent header control, and identical networking observability to backend services.

## 2. BUILD INFRASTRUCTURE

### A. Runtime & Tooling
- **Base Image:** `node:24-alpine` (Current LTS as of 2026).
- **Package Manager:** `pnpm` (Strictly preferred over npm/yarn for speed).
- **Build System:** Vite 7+.

### B. Dockerfile Standard (Multi-Stage)
*This specific pattern ensures the final image is minimal (<30MB) and handles SPA routing correctly.*

```dockerfile
# STAGE 1: BUILD
FROM node:24-alpine AS builder
WORKDIR /app

# Enable corepack for pnpm support
RUN corepack enable

# Copy lockfiles first for caching
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm run build

# STAGE 2: SERVE
FROM nginx:alpine
# Copy build artifacts from Stage 1
COPY --from=builder /app/dist /usr/share/nginx/html

# SPA Routing Configuration
# Ensures /character/123 redirects to index.html instead of 404
RUN echo 'server { \
    listen 8080; \
    server_name localhost; \
    location / { \
        root /usr/share/nginx/html; \
        index index.html index.htm; \
        try_files $uri $uri/ /index.html; \
    } \
    # Optional: Cache control for hashed assets \
    location ~* \.(?:ico|css|js|gif|jpe?g|png)$ { \
        root /usr/share/nginx/html; \
        expires 1y; \
        add_header Cache-Control "public"; \
    } \
}' > /etc/nginx/conf.d/default.conf

# Cloud Run requires listening on PORT (defaults to 8080)
EXPOSE 8080
CMD ["nginx", "-g", "daemon off;"]
```

## 3. CLOUD RUN DEPLOYMENT

### A. Artifact Registry

- Repository Format: docker

- Location: us-central1 (Must match backend region).

- Image Tagging: STRICTLY use $GITHUB_SHA for immutable tags. Do not rely on :latest.

### B. Deploy Command
**Execute via CI/CD (GitHub Actions) using Workload Identity Federation.**

```bash
gcloud run deploy frontend-service \
  --image us-central1-docker.pkg.dev/$PROJECT_ID/frontend-repo/app:$GITHUB_SHA \
  --region us-central1 \
  --allow-unauthenticated \
  --memory 256Mi \
  --cpu 1 \
  --min-instances 0 \
  --max-instances 10 \
  --port 8080
```
## 4. ENVIRONMENT & CONFIGURATION
- Runtime Variables: Since the frontend is static after build, you cannot use process.env for runtime config.
- Config Injection: If runtime config is needed (e.g., API URLs that change per environment), inject them into window.ENV via a script in index.html or during the Docker build entrypoint.
- Secrets: Do NOT mount secrets (API Keys) to the frontend container. All client-side secrets are effectively public.

## 5. 2026 ECOSYSTEM CONSTRAINTS
- Tailwind v4: Ensure postcss config is removed/minimized. Tailwind v4 uses native Vite detection.
- React 19: Ensure strictly no Class Components.
- Strict Mode: TypeScript strict: true is mandatory.
